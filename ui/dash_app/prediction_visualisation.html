<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Food Donation Demand Prediction Report</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
  <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chrono-node/1.3.11/chrono.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.15.0/Recharts.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
  <div id="root"></div>
  <script type="text/babel">
    // Initializing React and dependencies
    const { useState, useEffect } = React;
    const { createRoot } = ReactDOM;

    // Cleaning and processing data
    const processAndCleanData = (data) => {
      return data
        .filter(row => row.date && row.location && row.actual !== undefined && row.predicted !== undefined)
        .map(row => ({
          date: chrono.parseDate(row.date) || new Date(row.date),
          location: row.location.trim(),
          type: row.type ? JSON.parse(row.type) : [],
          actual: parseFloat(row.actual) || 0,
          predicted: parseFloat(row.predicted) || 0,
        }))
        .filter(row => row.date instanceof Date && !isNaN(row.date) && !isNaN(row.actual) && !isNaN(row.predicted));
    };

    // Computing metrics
    const computeMetrics = (data) => {
      const errors = data.map(row => row.predicted - row.actual);
      const mae = errors.reduce((sum, err) => sum + Math.abs(err), 0) / errors.length;
      const rmse = Math.sqrt(errors.reduce((sum, err) => sum + err * err, 0) / errors.length);
      const nonZeroActual = data.filter(row => row.actual > 0).length;
      const nonZeroPredicted = data.filter(row => row.actual > 0 && row.predicted > 0).length;
      const recall = nonZeroActual > 0 ? nonZeroPredicted / nonZeroActual : 0;
      return { mae, rmse, recall };
    };

    // Extracting month for grouping
    const getMonth = (date) => {
      return date.toLocaleString('en-US', { month: 'short', year: 'numeric' });
    };

    // Main Report Component
    const Report = () => {
      const [data, setData] = useState([]);
      const [loading, setLoading] = useState(true);

      // Loading data
      useEffect(() => {
        const csv = loadFileData('predictions.csv');
        Papa.parse(csv, {
          header: true,
          skipEmptyLines: true,
          transformHeader: header => header.trim().replace(/^"|"$/g, ''),
          transform: (value, header) => value.trim().replace(/^"|"$/g, ''),
          complete: (results) => {
            const cleanedData = processAndCleanData(results.data);
            setData(cleanedData);
            setLoading(false);
          },
          error: (err) => {
            console.error('Error parsing CSV:', err);
            setLoading(false);
          },
        });
      }, []);

      if (loading) {
        return (
          <div className="flex justify-center items-center h-screen">
            <p className="text-xl text-gray-700">Loading data...</p>
          </div>
        );
      }

      // Computing metrics
      const metrics = computeMetrics(data);

      // Preparing data for monthly aggregation
      const monthlyData = data.reduce((acc, row) => {
        const month = getMonth(row.date);
        const key = `${month}_${row.location}`;
        if (!acc[key]) {
          acc[key] = { month, location: row.location, actual: 0, predicted: 0, count: 0 };
        }
        acc[key].actual += row.actual;
        acc[key].predicted += row.predicted;
        acc[key].count += 1;
        return acc;
      }, {});
      const monthlyAvg = Object.values(monthlyData).map(row => ({
        month: row.month,
        location: row.location,
        actual: row.actual / row.count,
        predicted: row.predicted / row.count,
      }));

      // Computing error distribution for box plot
      const errorData = data.map(row => ({
        location: row.location,
        error: row.predicted - row.actual,
      }));

      return (
        <div className="container mx-auto p-6 bg-white shadow-lg rounded-lg">
          {/* Rendering summary */}
          <h1 className="text-3xl font-bold text-gray-800 mb-4">Food Donation Demand Prediction Report</h1>
          <p className="text-gray-600 mb-6">
            This report analyzes food donation demand predictions for Region C and Tunis Center from August 9, 2025, to December 31, 2025. The data includes actual and predicted quantities across six food types: bakery, canned, dairy, dry goods, meat, and vegetables.
          </p>
          <h2 className="text-2xl font-semibold text-gray-700 mb-4">Summary</h2>
          <p className="text-gray-600 mb-4">
            The dataset contains {data.length} daily predictions for two locations. Tunis Center shows significant donation activity (mean actual: {data.filter(d => d.location === 'Tunis Center').reduce((sum, d) => sum + d.actual, 0) / data.filter(d => d.location === 'Tunis Center').length.toFixed(2)}), while Region C has zero actual donations but non-zero predictions (mean predicted: {data.filter(d => d.location === 'Region C').reduce((sum, d) => sum + d.predicted, 0) / data.filter(d => d.location === 'Region C').length.toFixed(2)}). Key metrics:
          </p>
          <ul className="list-disc list-inside text-gray-600 mb-6">
            <li>Mean Absolute Error (MAE): {metrics.mae.toFixed(2)} units</li>
            <li>Root Mean Squared Error (RMSE): {metrics.rmse.toFixed(2)} units</li>
            <li>Recall for Non-Zero Predictions: {(metrics.recall * 100).toFixed(2)}%</li>
          </ul>
          <p className="text-gray-600 mb-6 font-semibold">
            Interesting Fact: Region C has zero actual donations across all dates, despite predicted demand ranging from 41 to 80 units. This could indicate a data collection issue, a new location with no historical donations, or an over-optimistic model.
          </p>

          {/* Rendering time series line chart */}
          <h2 className="text-2xl font-semibold text-gray-700 mb-4">Actual vs. Predicted Demand Over Time</h2>
          <div className="mb-8">
            <Recharts.ResponsiveContainer width="100%" height={400}>
              <Recharts.LineChart data={data} margin={{ top: 10, right: 30, left: 20, bottom: 10 }}>
                <Recharts.CartesianGrid strokeDasharray="3 3" />
                <Recharts.XAxis dataKey="date" tickFormatter={date => date.toLocaleDateString()} fontSize={12} />
                <Recharts.YAxis label={{ value: 'Quantity (units)', angle: -90, position: 'insideLeft', offset: -10, fontSize: 12 }} fontSize={12} />
                <Recharts.Tooltip formatter={(value) => value.toFixed(2)} labelFormatter={date => new Date(date).toLocaleDateString()} />
                <Recharts.Legend />
                <Recharts.Line type="monotone" dataKey="actual" stroke="#8884d8" name="Actual" strokeWidth={2} dot={false} />
                <Recharts.Line type="monotone" dataKey="predicted" stroke="#82ca9d" name="Predicted" strokeWidth={2} dot={false} />
                <Recharts.Brush dataKey="date" height={30} stroke="#8884d8" travellerWidth={10} />
              </Recharts.LineChart>
            </Recharts.ResponsiveContainer>
          </div>

          {/* Rendering monthly bar chart */}
          <h2 className="text-2xl font-semibold text-gray-700 mb-4">Monthly Average Demand by Location</h2>
          <div className="mb-8">
            <Recharts.ResponsiveContainer width="100%" height={400}>
              <Recharts.BarChart data={monthlyAvg} margin={{ top: 10, right: 30, left: 20, bottom: 10 }}>
                <Recharts.CartesianGrid strokeDasharray="3 3" />
                <Recharts.XAxis dataKey="month" fontSize={12} />
                <Recharts.YAxis label={{ value: 'Average Quantity (units)', angle: -90, position: 'insideLeft', offset: -10, fontSize: 12 }} fontSize={12} />
                <Recharts.Tooltip formatter={(value) => value.toFixed(2)} />
                <Recharts.Legend />
                <Recharts.Bar dataKey="actual" fill="#8884d8" name="Actual" />
                <Recharts.Bar dataKey="predicted" fill="#82ca9d" name="Predicted" />
              </Recharts.BarChart>
            </Recharts.ResponsiveContainer>
          </div>

          {/* Rendering error distribution box plot */}
          <h2 className="text-2xl font-semibold text-gray-700 mb-4">Prediction Error Distribution by Location</h2>
          <div className="mb-8">
            <Recharts.ResponsiveContainer width="100%" height={400}>
              <Recharts.ScatterChart margin={{ top: 10, right: 30, left: 20, bottom: 10 }}>
                <Recharts.CartesianGrid />
                <Recharts.XAxis type="category" dataKey="location" fontSize={12} />
                <Recharts.YAxis label={{ value: 'Prediction Error (units)', angle: -90, position: 'insideLeft', offset: -10, fontSize: 12 }} fontSize={12} />
                <Recharts.Tooltip formatter={(value) => value.toFixed(2)} />
                <Recharts.Scatter name="Error" data={errorData} fill="#ff7300" />
              </Recharts.ScatterChart>
            </Recharts.ResponsiveContainer>
          </div>

          {/* Rendering conclusion */}
          <h2 className="text-2xl font-semibold text-gray-700 mb-4">Conclusion</h2>
          <p className="text-gray-600">
            The model predicts significant demand for Tunis Center, with reasonable accuracy (MAE: {metrics.mae.toFixed(2)} units), but struggles with Region C, where actual donations are consistently zero. This discrepancy suggests potential issues in data collection or model assumptions for Region C. For Tunis Center, predictions capture the trend but overestimate on some days (e.g., August 9, 2025: actual 117.95, predicted 247.04). Future improvements could include:
          </p>
          <ul className="list-disc list-inside text-gray-600 mb-6">
            <li>Investigating Region C’s zero actuals to validate data integrity.</li>
            <li>Adjusting the classifier threshold to reduce over-prediction.</li>
            <li>Incorporating per-type predictions for more granular insights.</li>
          </ul>
        </div>
      );
    };

    // Rendering the app
    const root = createRoot(document.getElementById('root'));
    root.render(<Report />);
  </script>
</body>
</html>